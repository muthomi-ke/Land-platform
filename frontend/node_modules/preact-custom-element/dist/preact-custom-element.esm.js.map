{"version":3,"file":"preact-custom-element.esm.js","sources":["../src/index.js"],"sourcesContent":["import { h, cloneElement, render, hydrate, Fragment } from 'preact';\n\n/**\n * @typedef {import('./internal.d.ts').PreactCustomElement} PreactCustomElement\n */\n\n/**\n * @type {import('./index.d.ts')}\n */\nexport default function register(Component, tagName, propNames, options) {\n\tfunction PreactElement() {\n\t\tconst inst = /** @type {PreactCustomElement} */ (\n\t\t\tReflect.construct(HTMLElement, [], PreactElement)\n\t\t);\n\t\tinst._vdomComponent = Component;\n\n\t\tif (options && options.shadow) {\n\t\t\tinst._root = inst.attachShadow({\n\t\t\t\tmode: options.mode || 'open',\n\t\t\t\tserializable: options.serializable ?? false,\n\t\t\t});\n\n\t\t\tif (options.adoptedStyleSheets) {\n\t\t\t\tinst._root.adoptedStyleSheets = options.adoptedStyleSheets;\n\t\t\t}\n\t\t} else {\n\t\t\tinst._root = inst;\n\t\t}\n\n\t\treturn inst;\n\t}\n\tPreactElement.prototype = Object.create(HTMLElement.prototype);\n\tPreactElement.prototype.constructor = PreactElement;\n\tPreactElement.prototype.connectedCallback = function () {\n\t\tconnectedCallback.call(this, options);\n\t};\n\tPreactElement.prototype.attributeChangedCallback = attributeChangedCallback;\n\tPreactElement.prototype.disconnectedCallback = disconnectedCallback;\n\n\t/**\n\t * @type {string[]}\n\t */\n\tpropNames =\n\t\tpropNames ||\n\t\tComponent.observedAttributes ||\n\t\tObject.keys(Component.propTypes || {});\n\tPreactElement.observedAttributes = propNames;\n\n\tif (Component.formAssociated) {\n\t\tPreactElement.formAssociated = true;\n\t}\n\n\t// Keep DOM properties and Preact props in sync\n\tpropNames.forEach((name) => {\n\t\tObject.defineProperty(PreactElement.prototype, name, {\n\t\t\tget() {\n\t\t\t\treturn this._vdom ? this._vdom.props[name] : this._props[name];\n\t\t\t},\n\t\t\tset(v) {\n\t\t\t\tif (this._vdom) {\n\t\t\t\t\tthis.attributeChangedCallback(name, null, v);\n\t\t\t\t} else {\n\t\t\t\t\tif (!this._props) this._props = {};\n\t\t\t\t\tthis._props[name] = v;\n\t\t\t\t}\n\n\t\t\t\t// Reflect property changes to attributes if the value is a primitive\n\t\t\t\tconst type = typeof v;\n\t\t\t\tif (\n\t\t\t\t\tv == null ||\n\t\t\t\t\ttype === 'string' ||\n\t\t\t\t\ttype === 'boolean' ||\n\t\t\t\t\ttype === 'number'\n\t\t\t\t) {\n\t\t\t\t\tthis.setAttribute(name, v);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t});\n\n\tcustomElements.define(\n\t\ttagName || Component.tagName || Component.displayName || Component.name,\n\t\tPreactElement\n\t);\n\n\treturn PreactElement;\n}\n\nfunction ContextProvider(props) {\n\tthis.getChildContext = () => props.context;\n\t// eslint-disable-next-line no-unused-vars\n\tconst { context, children, ...rest } = props;\n\treturn cloneElement(children, rest);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction connectedCallback(options) {\n\t// Obtain a reference to the previous context by pinging the nearest\n\t// higher up node that was rendered with Preact. If one Preact component\n\t// higher up receives our ping, it will set the `detail` property of\n\t// our custom event. This works because events are dispatched\n\t// synchronously.\n\tconst event = new CustomEvent('_preact', {\n\t\tdetail: {},\n\t\tbubbles: true,\n\t\tcancelable: true,\n\t});\n\tthis.dispatchEvent(event);\n\tconst context = event.detail.context;\n\n\tthis._vdom = h(\n\t\tContextProvider,\n\t\t{ ...this._props, context },\n\t\ttoVdom(this, this._vdomComponent, options)\n\t);\n\t(this.hasAttribute('hydrate') ? hydrate : render)(this._vdom, this._root);\n}\n\n/**\n * Camel-cases a string\n * @param {string} str The string to transform to camelCase\n * @returns camel case version of the string\n */\nfunction toCamelCase(str) {\n\treturn str.replace(/-(\\w)/g, (_, c) => (c ? c.toUpperCase() : ''));\n}\n\n/**\n * Changed whenver an attribute of the HTML element changed\n * @this {PreactCustomElement}\n * @param {string} name The attribute name\n * @param {unknown} oldValue The old value or undefined\n * @param {unknown} newValue The new value\n */\nfunction attributeChangedCallback(name, oldValue, newValue) {\n\tif (!this._vdom) return;\n\t// Attributes use `null` as an empty value whereas `undefined` is more\n\t// common in pure JS components, especially with default parameters.\n\t// When calling `node.removeAttribute()` we'll receive `null` as the new\n\t// value. See issue #50.\n\tnewValue = newValue == null ? undefined : newValue;\n\tconst props = {};\n\tprops[name] = newValue;\n\tprops[toCamelCase(name)] = newValue;\n\tthis._vdom = cloneElement(this._vdom, props);\n\trender(this._vdom, this._root);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction disconnectedCallback() {\n\trender((this._vdom = null), this._root);\n}\n\n/**\n * Pass an event listener to each `<slot>` that \"forwards\" the current\n * context value to the rendered child. The child will trigger a custom\n * event, where will add the context value to. Because events work\n * synchronously, the child can immediately pull of the value right\n * after having fired the event.\n */\nfunction Slot(props, context) {\n\tconst ref = (r) => {\n\t\tif (!r) {\n\t\t\tthis.ref.removeEventListener('_preact', this._listener);\n\t\t} else {\n\t\t\tthis.ref = r;\n\t\t\tif (!this._listener) {\n\t\t\t\tthis._listener = (event) => {\n\t\t\t\t\tevent.stopPropagation();\n\t\t\t\t\tevent.detail.context = context;\n\t\t\t\t};\n\t\t\t\tr.addEventListener('_preact', this._listener);\n\t\t\t}\n\t\t}\n\t};\n\tconst { useFragment, ...rest } = props;\n\treturn h(useFragment ? Fragment : 'slot', { ...rest, ref });\n}\n\nfunction toVdom(element, nodeName, options) {\n\tif (element.nodeType === 3) return element.data;\n\tif (element.nodeType !== 1) return null;\n\tlet children = [],\n\t\tprops = {},\n\t\ti = 0,\n\t\ta = element.attributes,\n\t\tcn = element.childNodes;\n\tfor (i = a.length; i--; ) {\n\t\tif (a[i].name !== 'slot') {\n\t\t\tprops[a[i].name] = a[i].value;\n\t\t\tprops[toCamelCase(a[i].name)] = a[i].value;\n\t\t}\n\t}\n\n\tfor (i = cn.length; i--; ) {\n\t\tconst vnode = toVdom(cn[i], null, options);\n\t\t// Move slots correctly\n\t\tconst name = cn[i].slot;\n\t\tif (name) {\n\t\t\tprops[name] = h(Slot, { name }, vnode);\n\t\t} else {\n\t\t\tchildren[i] = vnode;\n\t\t}\n\t}\n\n\tconst shadow = !!(options && options.shadow);\n\n\t// Only wrap the topmost node with a slot\n\tconst wrappedChildren = nodeName\n\t\t? h(Slot, { useFragment: !shadow }, children)\n\t\t: children;\n\n\tif (!shadow && nodeName) {\n\t\telement.innerHTML = '';\n\t}\n\treturn h(nodeName || element.nodeName.toLowerCase(), props, wrappedChildren);\n}\n"],"names":["_excluded","_excluded2","register","Component","tagName","propNames","options","PreactElement","_options$serializable","inst","Reflect","construct","HTMLElement","_vdomComponent","shadow","_root","attachShadow","mode","serializable","adoptedStyleSheets","prototype","Object","create","constructor","connectedCallback","call","this","attributeChangedCallback","disconnectedCallback","observedAttributes","keys","propTypes","formAssociated","forEach","name","defineProperty","get","_vdom","props","_props","set","v","type","setAttribute","customElements","define","displayName","ContextProvider","getChildContext","context","children","rest","_objectWithoutPropertiesLoose","cloneElement","event","CustomEvent","detail","bubbles","cancelable","dispatchEvent","h","_extends","toVdom","hasAttribute","hydrate","render","toCamelCase","str","replace","_","c","toUpperCase","oldValue","newValue","undefined","Slot","_this","useFragment","Fragment","ref","r","_listener","stopPropagation","addEventListener","removeEventListener","element","nodeName","nodeType","data","i","a","attributes","cn","childNodes","length","value","vnode","slot","wrappedChildren","innerHTML","toLowerCase"],"mappings":"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"}